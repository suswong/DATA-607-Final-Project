---
title: "DATA 607 Final Project"
author: "Susanna Wong"
date: "2023-04-30"
output: 
  html_document:
    theme: cerulean
    code_folding: hide
    toc: true
    toc_float: true
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

# Data {.tabset}

Crime Data: Use publicly available arrest data from the New York City Open Data.
The data includes information such as the type of crime, the location and date of the arrest, information of perpetrators.
https://data.cityofnewyork.us/Public-Safety/NYPD-Arrests-Data-Historic-/8h9b-rp9u

NY Borough Population Size: Webscrap population size of each NY borough from CityPopulation.
The website contains the population of each NY borough according to census results.
<https://www.citypopulation.de/en/usa/newyorkcity/>

## NYC Open Data

There are over 5 million arrest recorded on "NYPD Arrests Data (Historical)" dataset. It contains every arrest made from 2006 to 2022. For this project, we will be using every arrest made from 2018 to 2022. Below is a breakdown of each column of the dataset, which was extracted from the NYC Open Data website. 


| Column Name            | Description                                                                                                                                                          | Data Type |
|-------------------|-------------------------------|----------------------|
| ARREST_KEY             | Randomly generated persistent ID for each arrest                                                                                                                     | int       |
| ARREST_DATE            | Exact date of arrest for the reported event                                                                                                                          | chr       |
| PD_CD                  | Three digit internal classification code (more granular than Key Code)                                                                                               | int       |
| PD_DESC                | Description of internal classification corresponding with PD code (more granular than Offense Description)                                                           | chr       |
| KY_CD                  | Three digit internal classification code (more general category than PD code)                                                                                        | int       |
| OFNS_DESC              | Description of internal classification corresponding with KY code (more general category than PD description)                                                        | chr       |
| LAW_CODE               | Law code charges corresponding to the NYS Penal Law, VTL and other various local laws                                                                                | chr       |
| LAW_CAT_CD             | Level of offense: felony, misdemeanor, violation                                                                                                                     | chr       |
| ARREST_BORO            | Borough of arrest. B(Bronx), S(Staten Island), K(Brooklyn), M(Manhattan), Q(Queens)                                                                                  | chr       |
| ARREST_PRECINCT        | Precinct where the arrest occurred                                                                                                                                   | int       |
| JURISDICTION_CODE      | Jurisdiction responsible for arrest. Jurisdiction codes 0(Patrol), 1(Transit) and 2(Housing) represent NYPD whilst codes 3 and more represent non NYPD jurisdictions | int       |
| AGE_GROUP              | Perpetrator's age within a category                                                                                                                                  | chr       |
| PERP_SEX               | Perpetrator's sex description                                                                                                                                        | chr       |
| PERP_RACE              | Perpetrator's race description                                                                                                                                       | chr       |
| X_COORD_CD             | Midblock X-coordinate for New York State Plane Coordinate System, Long Island Zone, NAD 83, units feet (FIPS 3104)                                                   | int       |
| Y_COORD_CD             | Midblock Y-coordinate for New York State Plane Coordinate System, Long Island Zone, NAD 83, units feet (FIPS 3104)                                                   | int       |
| Latitude               | Latitude coordinate for Global Coordinate System, WGS 1984, decimal degrees (EPSG 4326)                                                                              | num       |
| Longitude              | Longitude coordinate for Global Coordinate System, WGS 1984, decimal degrees (EPSG 4326)                                                                             | num       |
| Lon_Lat                | Georeferenced Point Column based on Longitude and Latitude fields                                                                                                    | chr       |
| Zip.Codes              | Zip code of arrest                                                                                                                                                   | int       |
| Community.Districts    |                                                                                                                                                                      | int       |
| Borough.Boundaries     |                                                                                                                                                                      | int       |
| City.Council.Districts |                                                                                                                                                                      | int       |
| Police.Precincts       |                                                                                                                                                                      | int       |

```{r}
data_2022 <- read.csv("https://raw.githubusercontent.com/suswong/DATA-607-Final-Project/main/NYPD_Arrests_Data__Historic_-2022.csv", header = T, na.strings = "NA")

data_2021 <- read.csv("https://raw.githubusercontent.com/suswong/DATA-607-Final-Project/main/NYPD_Arrests_Data__Historic_-2021.csv", header = T, na.strings = "NA")

data_2020 <- read.csv("https://raw.githubusercontent.com/suswong/DATA-607-Final-Project/main/NYPD_Arrests_Data__Historic_-2020.csv", header = T, na.strings = "NA")

data_2019 <- read.csv("https://raw.githubusercontent.com/suswong/DATA-607-Final-Project/main/NYPD_Arrests_Data__Historic_-2019.csv", header = T, na.strings = "NA")

data_2018 <- read.csv("https://raw.githubusercontent.com/suswong/DATA-607-Final-Project/main/NYPD_Arrests_Data__Historic_2018.csv", header = T, na.strings = "NA")

data_2018_2022 <- rbind(data_2018,data_2019,data_2020,data_2021,data_2022)
```

## NY Population

```{r}
library(rvest)
web = read_html("https://www.citypopulation.de/en/usa/newyorkcity/")
HTML_df <- html_table(web) 
population <- HTML_df[[1]]

library(DT)
datatable(population)
```

# Tidying Data {.tabset}

## NYC Arrest Data {.tabset}

Below are some of things that needs to be tidied for the analysis:

-   Remove columns that are not needed in the analysis

-   Rename values in the 'ARREST_BORO' column

-   Change format of 'ARREST_DATE' to date format

-   Missing values

### Remove Duplicates

Each crime has a randomly generated persistent ID. They are recorded in the 'ARREST_KEY' column. Below is code that removes another duplicates based on the ID. 

```{r}
data_2018_2022 <- subset(data_2018_2022, !duplicated(data_2018_2022$ARREST_KEY))
```

### Remove columns

Use `str()` to check the structure of each dataset.

We do not need the following columns in our analysis:

-   ARREST_KEY

-   PD_CD

-   KY_CD

-   LAW_CODE

-   ARREST_PRECINCT

-   JURISDICTION_CODE

-   Community.Districts

-   Borough.Boundaries

-   City.Council.Districts

-   Police.Precincts

```{r}
str(data_2018_2022)
# 
# library(dplyr)
# data_2018_2022 <- data_2018_2022 %>%
#   select(-ARREST_KEY,-KY_CD, -PD_CD, -LAW_CODE, -ARREST_PRECINCT, -JURISDICTION_CODE, -Community.Districts, -Borough.Boundaries, -City.Council.Districts, -Police.Precincts)

```

### Rename Values in 'ARREST_BORO' and 'LAW_CAT_CD'

The 'ARREST_BORO' column contains the borough in which the arrest was made.
The 'LAW_CAT_CD' column contains the level of offense: felony, misdemeanor, violation.
However, those values are in abbreviation.

```{r, message=FALSE}
data_2018_2022$ARREST_BORO[grep("B", data_2018_2022$ARREST_BORO)] <- "Bronx"
data_2018_2022$ARREST_BORO[grep("K", data_2018_2022$ARREST_BORO)] <- "Brooklyn"
data_2018_2022$ARREST_BORO[grep("M", data_2018_2022$ARREST_BORO)] <- "Manhattan"
data_2018_2022$ARREST_BORO[grep("Q", data_2018_2022$ARREST_BORO)] <- "Queens"
data_2018_2022$ARREST_BORO[grep("S", data_2018_2022$ARREST_BORO)] <- "Staten Island"

data_2018_2022$LAW_CAT_CD[grep("F", data_2018_2022$LAW_CAT_CD)] <- "Felony"
data_2018_2022$LAW_CAT_CD[grep("M", data_2018_2022$LAW_CAT_CD)] <- "Misdemeanor"
data_2018_2022$LAW_CAT_CD[grep("V", data_2018_2022$LAW_CAT_CD)] <- "Violation"
```

### Change format of 'ARREST_DATE'

The 'ARREST_DATE' needs to be converted to date format.

```{r, message=FALSE}
library(lubridate)
data_2018_2022$ARREST_DATE <- as.Date(data_2018_2022$ARREST_DATE, format = "%m/%d/%Y" )

data_2018_2022$YEAR <- as.numeric(format(data_2018_2022$ARREST_DATE,'%Y'))
data_2018_2022$DAY <-  wday(data_2018_2022$ARREST_DATE, label=TRUE)
data_2018_2022$MONTH <- months(data_2018_2022$ARREST_DATE, abbreviate=TRUE)
```

### Missing Values

Use `colSums(is.na())` to check for missing values.
There are 2093 missing values in the 'Zip.Codes' column.

```{r}
colSums(is.na(data_2018_2022))

data_2018_2022 <- data_2018_2022[complete.cases(data_2018_2022),]

data_2018_2022 <- data_2018_2022 %>%
  dplyr::filter(OFNS_DESC !="") %>%
  dplyr::filter(OFNS_DESC != "(null)")

colSums(is.na(data_2018_2022))

```

### Duplicates

Check for duplicates

```{r}
dplyr::distinct(data_2018_2022)
```

### Group similar crimes

There are 78 crime types. We can combine some of the crimes into one type as some are similar. For example there are crime type called "CHILD ABANDONMENT/NON SUPPORT" and "CHILD ABANDONMENT/NON SUPPORT 1". They could be mislabeled. Create a new column to group similar crime types. 

```{r}
table(data_2018_2022$OFNS_DESC)
length(unique(table(data_2018_2022$OFNS_DESC)))

# Copy 'OFNS_DESC' into a new column called 'crime'
data_2018_2022$crime <- as.character(data_2018_2022$OFNS_DESC)

### Group similar names (Maybe some values are misspelled)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("ADMINISTRATIVE CODE","ADMINISTRATIVE CODES"),"ADMINISTRATIVE CODE", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("CHILD ABANDONMENT/NON SUPPORT","CHILD ABANDONMENT/NON SUPPORT 1"),"CHILD ABANDONMENT", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("CRIMINAL MISCHIEF & RELATED OF","CRIMINAL MISCHIEF & RELATED OFFENSES"),"CRIMINAL MISCHIEF & RELATED OFFENSES", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("DISRUPTION OF A RELIGIOUS SERV","DISRUPTION OF A RELIGIOUS SERVICE"),"DISRUPTION OF A RELIGIOUS SERVICE", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("HARASSMENT","HARRASSMENT 2"),"HARASSMENT", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("INTOXICATED & IMPAIRED DRIVING","INTOXICATED/IMPAIRED DRIVING"),"INTOXICATED & IMPAIRED DRIVING", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("HOMICIDE-NEGLIGENT,UNCLASSIFIE","HOMICIDE-NEGLIGENT,UNCLASSIFIED"),"HOMICIDE-NEGLIGENT,UNCLASSIFIED", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("KIDNAPPING","KIDNAPPING & RELATED OFFENSES", "KIDNAPPING AND RELATED OFFENSES"),"KIDNAPPING", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("MURDER & NON-NEGL. MANSLAUGHTE","MURDER & NON-NEGL. MANSLAUGHTER"),"MURDER & NON-NEGL. MANSLAUGHTER", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("POSSESSION OF STOLEN PROPERTY","POSSESSION OF STOLEN PROPERTY 5"),"POSSESSION OF STOLEN PROPERTY", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("OTHER STATE LAWS (NON PENAL LAW)","OTHER STATE LAWS (NON PENAL LA"),"OTHER STATE LAWS (NON PENAL LAW)", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("UNAUTHORIZED USE OF A VEHICLE","UNAUTHORIZED USE OF A VEHICLE 3 (UUV)"),"UNAUTHORIZED USE OF A VEHICLE", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("LOITERING","LOITERING FOR DRUG PURPOSES","LOITERING/GAMBLING (CARDS, DIC", "LOITERING/GAMBLING (CARDS, DICE, ETC)"),"LOITERING", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("OFFENSES AGAINST PUBLIC ADMINISTRATION","OFFENSES AGAINST PUBLIC ADMINI"),"OFFENSES AGAINST PUBLIC ADMINISTRATION", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("OTHER OFFENSES RELATED TO THEF","OTHER OFFENSES RELATED TO THEFT"),"OTHER OFFENSES RELATED TO THEFT", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("OFF. AGNST PUB ORD SENSBLTY & RGHTS TO PRIV","OFF. AGNST PUB ORD SENSBLTY &"),"OFF. AGNST PUB ORD SENSBLTY & RGHTS TO PRIV", data_2018_2022$crime)

######## Grouping similar crimes

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("ASSAULT 3 & RELATED OFFENSES","FELONY ASSAULT"),"ASSAULT", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("BURGLAR'S TOOLS","BURGLARY"),"BURGLARY", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("FELONY SEX CRIMES","FORCIBLE TOUCHING","PROSTITUTION & RELATED OFFENSES", "SEX CRIMES"),"SEXUAL OFFENSES", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("OTHER OFFENSES RELATED TO THEF","OTHER OFFENSES RELATED TO THEFT","THEFT OF SERVICES", "POSSESSION OF STOLEN PROPERTY"),"THEFT", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("GRAND LARCENY", "GRAND LARCENY OF MOTOR VEHICLE"),"GRAND LARCENY", data_2018_2022$crime)


data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("FRAUDS","FRAUDULENT ACCOSTING","OFFENSES INVOLVING FRAUD", "FORGERY"),"FRAUD", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("CANNABIS RELATED OFFENSES","DANGEROUS DRUGS"),"DRUG", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("OTHER STATE LAWS","OTHER STATE LAWS (NON PENAL LAW)"),"OTHER STATE LAWS", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("HOMICIDE-NEGLIGENT-VEHICLE","HOMICIDE-NEGLIGENT,UNCLASSIFIED"),"HOMICIDE-NEGLIGENT", data_2018_2022$crime)

data_2018_2022$crime <- ifelse(data_2018_2022$crime %in% c("VEHICLE AND TRAFFIC LAWS","UNAUTHORIZED USE OF A VEHICLE", "OTHER TRAFFIC INFRACTION", "INTOXICATED & IMPAIRED DRIVING", "MOVING INFRACTIONS", "PARKING OFFENSES"),"VEHICLE AND TRAFFIC LAWS", data_2018_2022$crime)

table(data_2018_2022$crime)
length(unique(table(data_2018_2022$crime)))
```

## NY Population by Borough {.tabset}

To calculate the crime rate by borough, we need the population of each borough.
We will only need the population census in 2020.

Below are some of things that needs to be tidied for the analysis:

-   Remove columns that are not needed in the analysis

-   Rename column labels

-   Change format of the population column to numeric

### Remove columns

Removes the other years' population size except for 2020

```{r}
population_boro <- population[, -c(2:5,7:8)] #Removes the other years' population size except for 2020

population_boro <- as.data.frame(population_boro)
datatable(population_boro)
```

### Rename Column and Values

```{r}
colnames(population_boro) <- c("Borough", "Population_Census_2020")
population_boro$Borough[grep("Bronx", population_boro$Borough)] <- "Bronx"
population_boro$Borough[grep("Brooklyn", population_boro$Borough)] <- "Brooklyn"
population_boro$Borough[grep("Staten Island", population_boro$Borough)] <- "Staten Island"
population_boro$Borough[grep("Manhattan", population_boro$Borough)] <- "Manhattan"

str(population_boro)

population_boro$Population_Census_2020 <- as.numeric(gsub(",","",population_boro$Population_Census_2020))
```

# Interactive Map Visusalization

Here we have an interactive map of all arrests made in New York from 2018-2022. 

```{r, message=FALSE}
library(dplyr)
library(leaflet)
library(RColorBrewer)
arrests<-rename(data_2022,lat=Latitude,lng=Longitude, radius = 5)
info<-paste("<b>Offense: </b>",arrests$PD_DESC,"<br>",
            "<b>Perpetrator Gender: </b>",arrests$PERP_SEX,"<br>",
            "<b>Perpetrator Age: </b>",arrests$AGE_GROUP,"<br>",
            "<b>Perpetrator Race: </b>",arrests$PERP_RACE,sep = "")

pal<-colorFactor(c("blue","darkgreen","red"),arrests$LAW_CAT_CD)

arrests_map <- arrests %>%
  leaflet()%>%
  addTiles()%>%
    addCircleMarkers(clusterOptions=markerClusterOptions(),
               popup=info,color=pal(arrests$LAW_CAT_CD)) 
# %>%
#     addLegend(labels=c("Free - Unlimited","Free - Limited","Partner"),colors=c("blue","darkgreen","red"))
arrests_map
```

# Daily Crimes in New York from 2018 – 2022

Overall, there is a decrease in the number of crimes from 2018 to mid 2020 and a increase in the number of crimes from mid 2020 to end of 2022. 
```{r, message=FALSE}
crime_daily <- data_2018_2022 %>%
  group_by(ARREST_DATE) %>%
  summarize(count = n()) %>%
  arrange(ARREST_DATE)

library(ggplot2)
library(scales)
ggplot(crime_daily, aes(x = ARREST_DATE, y = count)) +
  geom_line(color = "#F2CA27", size = 0.1) +
  geom_smooth(color = "#1A1A1A") +
  # fte_theme() +
  scale_x_date(breaks = date_breaks("1 year"), labels = date_format("%Y")) +
  labs(x = "Date of Crime", y = "Number of Crimes", title = "Daily Crimes in New York from 2018 – 2022")

```

## Trends in Crime of During the Week Per Year

Based on the graph, there seems to be more crimes in the middle of the week for each year. In each year, the number of arrests peaks on Wednesday. 

```{r, message=FALSE}
library(gganimate)
library(gifski)

days_trend <- data_2018_2022 %>%
  group_by(DAY,YEAR) %>%
  summarise(count = n())

p <- days_trend %>%
  group_by(YEAR) %>%
    ggplot(., aes(x = DAY, y = count, fill = DAY)) + 
    geom_bar(stat = "identity", show.legend = FALSE) +
    labs(title = "Year: {closest_state}") +
    xlab("Day of week") +
    ylab("Number of crimes")

a <- p +
    transition_states(YEAR, wrap = FALSE)
animate(a, nframes = 5, fps = 0.5)

```

## Trends in Crime for Months of Each Year

Year 2020 crime trends differs the most compared to the other years. It may be related to the COVID outbreak in 2020 which led to a NY lockdown in March. 

```{r, message=FALSE, warning=FALSE}
month_trend <- data_2018_2022 %>%
  dplyr::group_by(MONTH,YEAR) %>%
  dplyr::summarise(count = n())

p <- month_trend %>%
  group_by(YEAR) %>%
    ggplot(., aes(x = reorder(MONTH, MONTH), y = count, fill = MONTH)) + 
    geom_bar(stat = "identity", show.legend = FALSE) +
    labs(title = "Year: {closest_state}") +
    xlab("Month") +
    ylab("Number of crimes")

a <- p +
    transition_states(YEAR, wrap = FALSE)
animate(a, nframes = 5, fps = 0.5)
```

# Top 10 Offenses in NY {.tabset}


## Datatable

Out of all the offenses, assault 3 & related offenses is the highest. 
```{r, message=FALSE}
library(DT)
library(dplyr)
offense <- data_2018_2022 %>%
  dplyr::group_by(crime) %>%
  dplyr::summarise(total = n()) 

offense2 <- data_2018_2022 %>%
  dplyr::group_by(crime, ARREST_BORO) %>%
  dplyr::summarise(count = n()) 
  
library(tidyr)
offense2 <- offense2 %>%
  pivot_wider(names_from = ARREST_BORO, values_from = count)

offense3 <- merge(x=offense2,y=offense, 
             by="crime", all.x=TRUE)

datatable(offense3)
```


## Visualization

```{r, message=FALSE}
library(ggplot2)

offense %>% 
    arrange(desc(total)) %>%
    slice(1:15) %>%
    ggplot(., aes(x=reorder(crime, total), y=total))+
              geom_bar(stat='identity', fill="lightblue") + coord_flip() + xlab("Offense")+ ylab("Count") +  
  ggtitle("Top 10 Offense in NY")
```

### Number of Arrests for Top 10 Crimes Daily Per Year

```{r, message=FALSE}
qw <- data_2018_2022 %>%
  filter(crime %in% c("ASSAULT","PETIT LARCENY","DRUG","FELONY ASSAULT","MISCELLANEOUS PENAL LAW" ,"VEHICLE AND TRAFFIC LAWS", "CRIMINAL MISCHIEF & RELATED OFFENSES" ,"ROBBERY","GRAND LARCENY" , "DANGEROUS WEAPONS","FRAUD"))

temp <- qw %>%
  dplyr::group_by(crime, DAY, YEAR)%>%
  dplyr::summarise(count = n())

temp2 <- temp %>%
  ggplot(., aes(x= crime, y= DAY, fill= count)) + 
  geom_tile(aes(fill= count)) +
scale_x_discrete("Crime", expand = c(0,0)) + 
  scale_y_discrete("Day of week", expand = c(0,-2)) + 
  scale_fill_gradient("Number of crimes", low = "white", high = "steelblue") +
theme_bw() + ggtitle("Year: {closest_state}") +
theme(panel.grid.major = element_line(colour = NA), panel.grid.minor = element_line(colour = NA)) + theme(axis.text.x=element_text(angle=45,hjust=1)) 

  
a <- temp2 +
    transition_states(YEAR, wrap = FALSE)
animate(a, nframes = 5, fps = 0.5)
```

# Crime Rate by Borough and Year {.tabset}

Calculate the crime rate for each borough by dividing the number of arrests in each borough by its population.
This will allow us to compare crime rates on an equal basis across different boroughs.

## Datatable

Below is a table of the crime rate per 100000 people for each borough and year. In all years except 2019, Queens has the lowest crime rate per 100000 people. Bronx has the highest crime per 10000 people for all years except in 2021. 

```{r, message=FALSE}
# Count the number of arrests in each borough by year
borough_by_year <- data_2018_2022 %>%
  dplyr::group_by(YEAR, ARREST_BORO) %>%
  dplyr::summarise(count = n()) 

# Create a new column for the population size for each borough
borough_by_year$population <- 
  with(borough_by_year, ifelse(ARREST_BORO == "Brooklyn", population_boro[2,2],
                         ifelse(ARREST_BORO == "Bronx", population_boro[1,2],
                        ifelse(ARREST_BORO == "Queens", population_boro[4,2],
                         ifelse(ARREST_BORO == "Manhattan", population_boro[3,2],population_boro[5,2]      )))))

# Rename column names
colnames(borough_by_year) <- c("Year" ,"Borough", "count", "population")

# Calculate the crime rate per year and borough
borough_by_year <- borough_by_year %>%
  mutate(crime_rate = (count/population)*10000)

datatable(borough_by_year,options = list(pageLength = 5, dom = 'tip'))
```

## Visualization

In all years except 2019, Queens has the lowest crime rate per 10000 people. Bronx has the highest crime per 10000 people for all years except in 2021. 

All of the boroughs follow a similar trend of a decrease of crime rate from 2018 to 2020 and an overall increase after. 

```{r, message=FALSE, warning=FALSE}
ggplot(borough_by_year, aes(x = Year, y = crime_rate, colour = Borough)) +
  geom_smooth() + scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) + ggtitle("Crime Rate Per 10000 People")
```


## Top Offense Per Borough {.tabset}

```{r, message=FALSE}
crime_by_borough <- data_2018_2022 %>%
  group_by(OFNS_DESC,ARREST_BORO) %>%
  summarise(count = n()) 

crime_by_borough$population <- 
  with(crime_by_borough, ifelse(ARREST_BORO == "Brooklyn", population_boro[2,2],
                         ifelse(ARREST_BORO == "Bronx", population_boro[1,2],
                        ifelse(ARREST_BORO == "Queens", population_boro[4,2],
                         ifelse(ARREST_BORO == "Manhattan", population_boro[3,2],population_boro[5,2]      )))))

crime_by_borough <- crime_by_borough %>%
  group_by(ARREST_BORO) %>%
  mutate(offense_rate = (count/sum(count)))

# crime_by_borough <- crime_by_borough %>%
#   filter(crime_rate > 5000)
  
```

```{r, message=FALSE}
#install.packages("gganimate")
#install.packages("gifski")

library(gganimate)
library(gifski)

p <- crime_by_borough %>%
  arrange(desc(offense_rate)) %>%
  group_by(ARREST_BORO) %>%
  slice(1:10) %>%
    ggplot(., aes(x = reorder(OFNS_DESC, offense_rate),
                                                 y = offense_rate,
                                                 fill = ARREST_BORO)) + 
    geom_bar(stat = "identity", show.legend = FALSE) +
    labs(title = "") +
    coord_flip()  + 
    xlab("Offense") +
    ylab("Offense Rate") +
  ggtitle("Borough: {closest_state}")

a <- p +
    transition_states(ARREST_BORO, wrap = FALSE)
animate(a, nframes = 5, fps = 0.5)
```

### Trends of Top 10 Crimes in Manhattan

```{r, warning=FALSE, message=FALSE}
temp100 <- qw %>%
  group_by(ARREST_DATE, ARREST_BORO, crime)%>%
  summarise(total = n())

temp100  %>%
  filter(ARREST_BORO=="Manhattan") %>%
  ggplot(aes(ARREST_DATE, total, colour = crime)) +
  geom_smooth()
```

### Trends of Top 10 Crimes in Brooklyn

```{r, warning=FALSE, message=FALSE}
temp100  %>%
  filter(ARREST_BORO=="Brooklyn") %>%
  ggplot(aes(ARREST_DATE, total, colour = crime)) +
  geom_smooth()
```

### Trends of Top 10 Crimes in Bronx

```{r, warning=FALSE, message=FALSE}

temp100  %>%
  filter(ARREST_BORO=="Bronx") %>%
  ggplot(aes(ARREST_DATE, total, colour = crime)) +
  geom_smooth()

```

### Trends of Top 10 Crimes in Brooklyn

```{r, warning=FALSE, message=FALSE}
temp100  %>%
  filter(ARREST_BORO=="Brooklyn") %>%
  ggplot(aes(ARREST_DATE, total, colour = crime)) +
  geom_smooth()
```

### Trends of Top 10 Crimes in Queen

```{r, warning=FALSE, message=FALSE}
temp100  %>%
  filter(ARREST_BORO=="Queen") %>%
  ggplot(aes(ARREST_DATE, total, colour = crime)) +
  geom_smooth()
```

# Demographic of Perpetraitor in Each Borough

## Gender
```{r, message=FALSE}
gender <- data_2018_2022 %>%
  group_by(PERP_SEX, ARREST_BORO)%>%
  summarise(count = n())

gender <- gender %>%
  group_by(ARREST_BORO) %>%
  mutate(percentage = (count/sum(count)))

ggplot(gender, aes (x = factor(percentage), y = percentage, fill = PERP_SEX))+
    geom_bar(stat="identity", na.rm = TRUE)+
    facet_wrap(~ARREST_BORO, ncol =3, scales = "free_x", drop = TRUE) +
    theme(
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()
    )

```

## Race by Borough

```{r, message=FALSE}
race_by_borough <- data_2018_2022 %>%
  dplyr::group_by(PERP_RACE, ARREST_BORO)%>%
  dplyr::summarise(count = n())

race_by_borough <- race_by_borough %>%
  dplyr::group_by(ARREST_BORO) %>%
  dplyr::mutate(percentage = (count/sum(count)))%>%
  dplyr::mutate(labels = scales::percent(percentage ))


ggplot(race_by_borough, aes (x = factor(percentage), y = percentage, fill = PERP_RACE))+
    geom_bar(stat="identity", na.rm = TRUE)+
    facet_wrap(~ARREST_BORO, ncol =3, scales = "free_x", drop = TRUE) +
    theme(
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank() 
    )


# ggplot(data=race_by_borough, aes(x=" ", y=percentage, group=PERP_RACE, colour=PERP_RACE, fill=PERP_RACE)) +
#          geom_bar(width = 1, stat = "identity") +
#          coord_polar("y", start=0) + 
#    geom_text(aes(label = labels),
#             position = position_stack(vjust = 0.5)) +
#          facet_grid(.~ ARREST_BORO) +theme_void()

```

# Changes in Crime Rate from 2018 - 2022 {.tabset}

```{r}
arrests_2018 <- borough_by_year %>%
  filter(Year == 2018)
arrests_2021 <- borough_by_year %>%
  filter(Year == 2021)
arrests_2022 <- borough_by_year %>%
  filter(Year == 2022)

arrests_combined2018_2022 <- merge(arrests_2018, arrests_2022, by = c("Borough"), all = TRUE)

arrests_combined2018_2022 <- arrests_combined2018_2022[,-2]
arrests_combined2018_2022 <- arrests_combined2018_2022[,-2]
arrests_combined2018_2022 <- arrests_combined2018_2022[,-2]
arrests_combined2018_2022 <- arrests_combined2018_2022[,-3]
arrests_combined2018_2022 <- arrests_combined2018_2022[,-3]
arrests_combined2018_2022 <- arrests_combined2018_2022[,-3]
arrests_combined2018_2022$Arrests_2021 <- arrests_2021$crime_rate

names(arrests_combined2018_2022) <- c("BORO","Arrests 2018", "Arrests 2022", "Arrests 2021")

arrests_combined2018_2022$`% Change from 2018 to 2022` <- (arrests_combined2018_2022$`Arrests 2022` - arrests_combined2018_2022$`Arrests 2018`) / arrests_combined2018_2022$`Arrests 2018` * 100

arrests_combined2018_2022$`% Change from 2021 to 2022` <- (arrests_combined2018_2022$`Arrests 2022` - arrests_combined2018_2022$`Arrests 2021`) / arrests_combined2018_2022$`Arrests 2021` * 100

datatable(arrests_combined2018_2022)
```



# Source

1.  Interactive map <https://crimebythenumbers.com/choropleth-maps.html> <https://walker-data.com/census-r/mapping-census-data-with-r.html> <https://justinmorganwilliams.medium.com/basics-of-gis-mapping-with-r-using-grow-nyc-markets-75adcdd9b0> <https://cengel.github.io/R-spatial/mapping.html> <https://rpubs.com/schwarja209/NYC_hotspots>
